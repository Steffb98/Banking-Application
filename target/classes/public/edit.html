<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset= "utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="style/edit.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

  <div class="container">
    <a href="home.html">
      <img src="style/logo.png" class="logo">
    </a>
    <a href="/perform_logout">
      <img src="style/logout.png" class="logout">
    </a>

    <p id="name" for="name"></p>
    <hr>

    <div id="password_div" class="box">
      <div id="edit" class="block">
        <h3>Change your password</h3>
        <hr>

        <label for="c_pwCheck"><b>Enter old password</b></label>
        <input type="password" placeholder="Enter old password" id="c_pwCheck" required>

        <label for="pw"><b>Password</b></label>
        <input type="password" placeholder="Enter a new Password" id="pw"  required>

        <label for="cpw"><b>Confirm Password</b></label>
        <input type="password" placeholder="Repeat Password" id="cpw" required>

        <input type="button" name= "change_pw" id="change_pw" class="btn" value="Change password">
      </div>
    </div>

    <div class="vl" id="v1"></div>

    <div id="email_div" class="box">
      <div id="edit" class="block">
        <h3>Change your Username</h3>
        <hr>

        <label for="username"><b>Username</b></label>
        <input type="text" placeholder="Enter a new username" id="username"  required>

        <label for="c_username"><b>Confirm Username</b></label>
        <input type="text" placeholder="Repeat new username" id="c_username" required>

        <label for="c_username_pwcheck"><b>Enter password</b></label>
        <input type="password" placeholder="Enter password" id="c_username_pwcheck" required>

        <input type="button" name= "change_username" class="btn" id="change_username" value="Change Username">
      </div>
    </div>

    <a href="home.html">
        <button id="cancel" class="btn">Cancel</button>
    </a>
  </div>

</body>
</html>
<script>


  var loggedInUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
  $(document).ready(function(){
    $('#name').text(loggedInUser.firstname + " " + loggedInUser.lastname + " | " + loggedInUser.userId);
    $("#change_pw").click(function(){
      updatePassword()
    })
    $("#change_username").click(function(){
      updateUserName();
    })
    
  });

  function updateUserName()

  {
    // information still updates but always shows this alert..
    // This happens because the password is compared to the hashed password of "loggedInUser"
    if ($('#c_username_pwcheck').val() !== loggedInUser.password)
    {
      alert("Invalid password entered");
      location.reload();
    }


    var user = {};
    user["firstname"] = loggedInUser.firstname;
    user["lastname"] = loggedInUser.lastname;
    user["username"] = $('#username').val();
    user["password"] = $('#c_username_pwcheck').val();
    user = JSON.stringify(user);

    $.ajax({
      url: 'user/' + loggedInUser.userId,
      type: 'PUT',
      contentType: "application/json",
      data: user,
      success: function (response) {
        alert(response.responseText);
        location.reload();
      },
      error: function (error) {
        alert(error.responseText);
      }
    });
  }

  function updatePassword()
  {
    // information still updates but always shows this alert..
    // This happens because the password is compared to the hashed password of "loggedInUser"
    // if ($('#c_pwCheck').val() !== loggedInUser.password)
    // {
    //   alert("Old password is invalid");
    //   location.reload();
    // }

    if ($('#pw').val() !== $('#cpw').val())
    {
      alert("Passwords do not match!");
      location.reload();
    }

    var user = {}
    user["firstname"] = loggedInUser.firstname;
    user["lastname"] = loggedInUser.lastname;
    user["username"] = $('#username').val();
    user["password"] = $('#pw').val();
    user = JSON.stringify(user);

    $.ajax({
      url: 'user/' + loggedInUser.userId,
      type: 'PUT',
      contentType: "application/json",
      data: user,
      success: function (response) {
        alert(response.responseText);
        location.reload();
      },
      error: function (error) {
        alert(error.responseText);
      }
    });
  }


  
</script>
